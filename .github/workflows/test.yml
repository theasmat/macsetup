name: ğŸ§ª Test Mac Setup Script

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  syntax-check:
    name: ğŸ“ Bash Syntax Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Check bash syntax
      run: |
        bash -n mac-dev-setup.sh
        echo "âœ… Bash syntax check passed!"

  shellcheck:
    name: ğŸ›¡ï¸ ShellCheck Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: '.'
        format: gcc
        severity: warning
        additional_files: 'mac-dev-setup.sh'

  html-validation:
    name: ğŸŒ HTML Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Validate HTML
      uses: Cyb3r-Jak3/html5validator-action@v7.2.0
      with:
        root: .
        format: text

  link-check:
    name: ğŸ”— Link Checker
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Check links in markdown files
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/markdown-link-check-config.json'

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'
      continue-on-error: true

  test-script-structure:
    name: ğŸ—ï¸ Script Structure Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Test script structure
      run: |
        echo "ğŸ” Checking script structure..."
        
        # Check if main function exists
        if grep -q "^main()" mac-dev-setup.sh; then
          echo "âœ… Main function found"
        else
          echo "âŒ Main function not found"
          exit 1
        fi
        
        # Check if all required functions are defined
        required_functions=(
          "ask_yes_no"
          "print_success"
          "print_warning"
          "print_info"
          "install_core_tools"
          "install_browsers"
          "install_ides"
          "configure_environments"
        )
        
        for func in "${required_functions[@]}"; do
          if grep -q "^${func}()" mac-dev-setup.sh; then
            echo "âœ… Function $func found"
          else
            echo "âŒ Function $func not found"
            exit 1
          fi
        done
        
        echo "âœ… All required functions found!"

  test-website:
    name: ğŸŒ Website Functionality Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ” Test JavaScript syntax
      run: |
        echo "ğŸ” Checking JavaScript syntax..."
        node -c assets/script.js
        echo "âœ… JavaScript syntax check passed!"
        
    - name: ğŸ” Check CSS validity
      run: |
        echo "ğŸ” Checking CSS structure..."
        # Basic CSS syntax check
        if grep -q ":root" assets/styles.css; then
          echo "âœ… CSS variables found"
        else
          echo "âŒ CSS variables not found"
          exit 1
        fi
        
        if grep -q "@media" assets/styles.css; then
          echo "âœ… Media queries found"
        else
          echo "âŒ Media queries not found"
          exit 1
        fi
        
        echo "âœ… CSS structure check passed!"

  documentation-check:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Check required documentation
      run: |
        echo "ğŸ” Checking documentation files..."
        
        required_docs=(
          "README.md"
          "CONTRIBUTING.md"
          ".github/pull_request_template.md"
          ".github/ISSUE_TEMPLATE/bug_report.md"
          ".github/ISSUE_TEMPLATE/feature_request.md"
        )
        
        for doc in "${required_docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "âœ… Documentation file $doc exists"
          else
            echo "âŒ Documentation file $doc missing"
            exit 1
          fi
        done
        
        echo "âœ… All documentation files found!"

  integration-test:
    name: ğŸ§ª Integration Test (Dry Run)
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Test script execution (dry run)
      run: |
        echo "ğŸ§ª Running integration test..."
        
        # Make script executable
        chmod +x mac-dev-setup.sh
        
        # Test that script can start (but don't actually install anything)
        # We'll modify the script to exit early in test mode
        
        # Check if script accepts parameters
        if ./mac-dev-setup.sh --help 2>/dev/null || true; then
          echo "âœ… Script accepts parameters"
        fi
        
        # Test syntax by sourcing without execution
        bash -n mac-dev-setup.sh
        echo "âœ… Script syntax is valid"
        
        # Check Homebrew detection logic
        if command -v brew >/dev/null 2>&1; then
          echo "âœ… Homebrew is available for testing"
        else
          echo "â„¹ï¸ Homebrew not available (expected in CI)"
        fi
        
        echo "âœ… Integration test completed!"

  notify-on-success:
    name: ğŸ‰ Success Notification
    runs-on: ubuntu-latest
    needs: [syntax-check, shellcheck, html-validation, link-check, test-script-structure, test-website, documentation-check, integration-test]
    if: success()
    
    steps:
    - name: ğŸ‰ All tests passed
      run: |
        echo "ğŸ‰ All tests passed successfully!"
        echo "âœ… Bash syntax check: PASSED"
        echo "âœ… ShellCheck analysis: PASSED" 
        echo "âœ… HTML validation: PASSED"
        echo "âœ… Link checking: PASSED"
        echo "âœ… Script structure: PASSED"
        echo "âœ… Website functionality: PASSED"
        echo "âœ… Documentation check: PASSED"
        echo "âœ… Integration test: PASSED"
        echo ""
        echo "ğŸš€ Ready for deployment!"

  notify-on-failure:
    name: âŒ Failure Notification
    runs-on: ubuntu-latest
    needs: [syntax-check, shellcheck, html-validation, link-check, test-script-structure, test-website, documentation-check, integration-test]
    if: failure()
    
    steps:
    - name: âŒ Tests failed
      run: |
        echo "âŒ Some tests failed!"
        echo "Please check the failed jobs above and fix the issues."
        echo "ğŸ’¡ Common issues:"
        echo "   - Bash syntax errors"
        echo "   - Missing functions"
        echo "   - Broken links"
        echo "   - Invalid HTML/CSS"
        echo ""
        echo "ğŸ“š See CONTRIBUTING.md for guidelines"
        exit 1